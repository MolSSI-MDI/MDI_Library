
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Driver Development Tutorial: Developing an MDI Driver for Running ab initio MD &#8212; MolSSI Driver Interface (MDI)  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=b0aaeb25" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'getting_started/writing_driver';</script>
    <link rel="icon" href="../_static/molssi_square.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="User Guide" href="../user_guide/index.html" />
    <link rel="prev" title="Driver Use Tutorial: Running an AIMD Simulation" href="running_driver.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/mdi-light.png" class="logo__image only-light" alt=""/>
    <img src="../_static/mdi-dark.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">MolSSI Driver Interface</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../developer_guide/index.html">
    Developer Guide
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://molssi.org">
    MolSSI
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MolSSI-MDI/MDI_Library" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/MolSSI_NSF" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../developer_guide/index.html">
    Developer Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://molssi.org">
    MolSSI
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/MolSSI-MDI/MDI_Library" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/MolSSI_NSF" title="Twitter" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-twitter fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Twitter</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="running_driver.html">Driver Use Tutorial: Running an AIMD Simulation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Driver Development Tutorial: Developing an MDI Driver for Running ab initio MD</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Getting Started</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Driver Development Tutorial: Developing an MDI Driver for Running ab initio MD</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="driver-development-tutorial-developing-an-mdi-driver-for-running-ab-initio-md">
<h1>Driver Development Tutorial: Developing an MDI Driver for Running ab initio MD<a class="headerlink" href="#driver-development-tutorial-developing-an-mdi-driver-for-running-ab-initio-md" title="Link to this heading">#</a></h1>
<section id="starting-a-new-driver-project">
<h2>Starting a New Driver Project<a class="headerlink" href="#starting-a-new-driver-project" title="Link to this heading">#</a></h2>
<p>The easiest way to start work on a new driver is to use the MDI Driver Cookiecutter, which will automatically do most of the preparatory work for you.
Using the cookiecutter will require that you have Python and Cookiecutter on your machine.
To install Cookiecutter, you can use <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="bash" for="sd-tab-item-0">
BASH</label><div class="sd-tab-content docutils">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>cookiecutter
</pre></div>
</div>
</div>
</div>
<p>If you are running on an external machine and do not have write permission to the system directories, you may need to add the \c –user option:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-1" name="sd-tab-set-1" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="bash" for="sd-tab-item-1">
BASH</label><div class="sd-tab-content docutils">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>--user<span class="w"> </span>cookiecutter
</pre></div>
</div>
</div>
</div>
<p>Now use Cookiecutter to create a new driver project:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-2" name="sd-tab-set-2" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="bash" for="sd-tab-item-2">
BASH</label><div class="sd-tab-content docutils">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cookiecutter<span class="w"> </span>git@github.com:MolSSI/MDI_Driver_Cookiecutter.git
</pre></div>
</div>
</div>
</div>
<p>When prompted for the \c repo_name, type \c aimd, and then when prompted to select a language, type \c 1 for C++.
This will create a new directory called \c aimd and populate it with some of the things you will need for the driver, including a copy of the MDI Library.
The overall directory structure is:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-3" name="sd-tab-set-3" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="bash" for="sd-tab-item-3">
BASH</label><div class="sd-tab-content docutils">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>.
└──<span class="w"> </span>aimd
<span class="w">    </span>├──<span class="w"> </span>CMakeLists.txt
<span class="w">    </span>├──<span class="w"> </span>aimd
<span class="w">        </span>├──<span class="w"> </span>CMakeLists.txt
<span class="w">        </span>├──<span class="w"> </span>STUBS_MPI
<span class="w">        </span>│<span class="w">   </span>└──<span class="w"> </span>mpi.h
<span class="w">        </span>└──<span class="w"> </span>aimd.cpp
<span class="w">        </span>└──<span class="w"> </span>mdi
<span class="w">            </span>...
</pre></div>
</div>
</div>
</div>
</section>
<section id="writing-the-driver">
<h2>Writing the Driver<a class="headerlink" href="#writing-the-driver" title="Link to this heading">#</a></h2>
<p>Open the file called <code class="docutils literal notranslate"><span class="pre">aimd.cpp</span></code>.
It contains the following code:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-4" name="sd-tab-set-4" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-4">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mpi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdexcept&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mdi.h&quot;</span>

<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="c1">// Initialize the MPI environment</span>
<span class="w">  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">world_comm</span><span class="p">;</span>
<span class="w">  </span><span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Initialize MDI</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;The MDI library was not initialized correctly.&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Confirm that MDI was initialized successfully</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">initialized_mdi</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDI_Initialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">initialized_mdi</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;MDI_Initialized failed.&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">initialized_mdi</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;MDI not initialized: did you provide the -mdi option?.&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Get the correct MPI intra-communicator for this code</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">MDI_MPI_get_world_comm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">world_comm</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;MDI_MPI_get_world_comm failed.&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Connect to the engines</span>
<span class="w">  </span><span class="c1">// &lt;YOUR CODE GOES HERE&gt;</span>

<span class="w">  </span><span class="c1">// Perform the simulation</span>
<span class="w">  </span><span class="c1">// &lt;YOUR CODE GOES HERE&gt;</span>

<span class="w">  </span><span class="c1">// Send the &quot;EXIT&quot; command to each of the engines</span>
<span class="w">  </span><span class="c1">// &lt;YOUR CODE GOES HERE&gt;</span>

<span class="w">  </span><span class="c1">// Synchronize all MPI ranks</span>
<span class="w">  </span><span class="n">MPI_Barrier</span><span class="p">(</span><span class="n">world_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">MPI_Finalize</span><span class="p">();</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The first few lines of code simply initialize both MPI and and MDI.
Don’t worry if you don’t have access to an MPI library - the code will just fall back to a set of dummy MPI functions provided in <code class="docutils literal notranslate"><span class="pre">STUBS_MPI</span></code>.
The call to the <code class="docutils literal notranslate"><span class="pre">MDI_MPI_get_world_comm()</span></code> function obtains from MDI an MPI intra-communicator that spans all MPI ranks associated with the driver.
This call is important when using the MPI protocol for MDI communication, because in that context, <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code> spans all ranks associated with both the driver and the engine(s).
In general, an MDI-enabled code should call <code class="docutils literal notranslate"><span class="pre">MDI_MPI_get_world_comm()</span></code> immediately after calling <code class="docutils literal notranslate"><span class="pre">MDI_Init()</span></code>, and the resulting MPI intra-communicator should be used instead of <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code> throughout the remainder of the code.</p>
<p>After initializing MDI, we need to connect the driver to its engines.
For this particular tutorial, we will use a QM engine to calculate forces and an MM engine to update the atomic coordinates each timestep.
In the MDI standard, engines request a connection to a driver.
The driver will need to call the <code class="docutils literal notranslate"><span class="pre">MDI_Accept_communicator()</span></code> function to accept each connection.
The general format of this functional call looks like this:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-5" name="sd-tab-set-5" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-5">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">MDI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="n">MDI_Accept_communicator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comm</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>This will assign a new MDI communicator to \c comm, which functions very similarly to an MPI communicator and is used in certain MDI function calls to identify which engine is expected to send/receive data to/from the driver.
Our AIMD driver will connect to two different engines, so we will be calling \c MDI_Accept_communicator() twice.
We don’t know the order in which the engines will request a connection to the driver, so we will need some way to determine which engine is the QM code and which engine is the MM code.</p>
<p>This can be accomplished through the use of the <code class="docutils literal notranslate"><span class="pre">&lt;NAME</span></code> command.
The entire MDI standard is built around the idea that drivers can send “commands” to engines, each of which is defined by the MDI standard and has a specific outcome.
The <code class="docutils literal notranslate"><span class="pre">&lt;NAME</span></code> command tells the engine to send the driver a string of length <code class="docutils literal notranslate"><span class="pre">MDI_NAME_LENGTH</span></code> that identifies the engine.
The end-user is responsible for indicating the name of each engine at runtime, using the <code class="docutils literal notranslate"><span class="pre">-name</span></code> command line argument that was described in the user_tutorial.
As authors of a driver, we will need to decide what we expect each of the engines to be named and clearly document that decision for the benefit of the end-users.
For the purpose of this tutorial, we will expect the quantum mechanics code to be called “QM” and the molecular mechanics code to be named “MM”.</p>
<p>Sending the <code class="docutils literal notranslate"><span class="pre">&lt;NAME</span></code> command to an engine and then receiving the engine’s name can be done as follows:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-6" name="sd-tab-set-6" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-6">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">code_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">MDI_NAME_LENGTH</span><span class="p">];</span>
<span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="n">MDI_Recv</span><span class="p">(</span><span class="n">code_name</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_NAME_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_CHAR</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="err">\</span><span class="n">endcode</span>

<span class="n">The</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="n">accepts</span><span class="w"> </span><span class="n">connections</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">engines</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">assigns</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">communicator</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="s">&quot;MM&quot;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">mm_comm</span><span class="err">`</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">assigns</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">communicator</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="s">&quot;QM&quot;</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="err">`</span><span class="n">qm_comm</span><span class="err">`</span><span class="p">.</span>
<span class="n">Replace</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">comment</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">reads</span><span class="w"> </span><span class="err">`</span><span class="c1">// Connect to the engines` with:</span>

<span class="err">\</span><span class="n">code</span>
<span class="w">  </span><span class="c1">// Connect to the engines</span>
<span class="w">  </span><span class="n">MDI_Comm</span><span class="w"> </span><span class="n">mm_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MDI_COMM_NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">MDI_Comm</span><span class="w"> </span><span class="n">qm_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MDI_COMM_NULL</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">nengines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iengine</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iengine</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nengines</span><span class="p">;</span><span class="w"> </span><span class="n">iengine</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MDI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="w">    </span><span class="n">MDI_Accept_communicator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Determine the name of this engine</span>
<span class="w">    </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">engine_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">MDI_NAME_LENGTH</span><span class="p">];</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="n">engine_name</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_NAME_LENGTH</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_CHAR</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Engine name: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">engine_name</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w"> </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">strcmp</span><span class="p">(</span><span class="n">engine_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;MM&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">mm_comm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MDI_COMM_NULL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">throw</span><span class="w"> </span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Accepted a communicator from a second MM engine.&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">mm_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">strcmp</span><span class="p">(</span><span class="n">engine_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;QM&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">qm_comm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MDI_COMM_NULL</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">	</span><span class="k">throw</span><span class="w"> </span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Accepted a communicator from a second QM engine.&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">qm_comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">comm</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Unrecognized engine name.&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w"> </span>
<span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">engine_name</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>We are now ready to use MDI to orchestrate an AIMD simulation.
In broad terms, during each dynamics iteration we will send a set of atomic coordinates from the MM engine to the QM engine, order the QM engine to send the driver the corresponding atomic forces, send those forces to the MM engine, and order the MM engine to perform a time step.</p>
<p>Keep in mind that the driver doesn’t know anything about the simulated system beyond what it can query by sending MDI commands.
MDI engines initialize basic information about the system using whatever input file format the engine’s developer chose.
When the MM and QM engines are launched, they will each read their standard input files, perform basic initialization tasks, and then request a connection to the driver.
The driver can request information about the engine’s system by sending certain MDI commands.
For example, to determine the number of atoms in the MM engine’s system, you could do:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-7" name="sd-tab-set-7" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-7">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Receive the number of atoms from the MM engine</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">natoms</span><span class="p">;</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;NATOMS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_INT</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="err">\</span><span class="n">endcode</span>

<span class="n">Similarly</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">learn</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">coordinates</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">atoms</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">MM</span><span class="w"> </span><span class="n">engine</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">system</span><span class="p">,</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">could</span><span class="w"> </span><span class="k">do</span><span class="o">:</span>

<span class="err">\</span><span class="n">code</span>
<span class="w">  </span><span class="c1">// Receive the coordinates from the MM engine</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">];</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;COORDS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>You could then update the coordinates of the QM engine’s system:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-8" name="sd-tab-set-8" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-8">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Send the coordinates to the QM engine</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&gt;COORDS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">MDI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-prerequisites admonition">
<p class="admonition-title">Prerequisites</p>
<p>As we will discuss later, this driver assumes that the engines have both been initialized with the same number of atoms, the same atom types and ordering of atom types, and the same cell dimensions.</p>
</div>
<p>The following code will handle all of the work associated with driving an AIMD simulation
Replace the comment that reads <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">Perform</span> <span class="pre">the</span> <span class="pre">simulation</span></code> with:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-9" name="sd-tab-set-9" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-9">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Perform the simulation</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">niterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">  </span><span class="c1">// Number of MD iterations</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">natoms</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">qm_energy</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">mm_energy</span><span class="p">;</span>
<span class="w"> </span>
<span class="w">  </span><span class="c1">// Receive the number of atoms from the MM engine</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;NATOMS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_INT</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">  </span><span class="c1">// Allocate the arrays for the coordinates and forces</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">coords</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">];</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">forces</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// Have the MM engine initialize a new MD simulation</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;@INIT_MD&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">  </span><span class="c1">// Perform each iteration of the simulation</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">iiteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iiteration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">niterations</span><span class="p">;</span><span class="w"> </span><span class="n">iiteration</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Receive the coordinates from the MM engine</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;COORDS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Send the coordinates to the QM engine</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&gt;COORDS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">coords</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Have the MM engine proceed to the @FORCES node</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;@FORCES&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Get the QM energy</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;ENERGY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qm_energy</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Get the MM energy</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;ENERGY&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mm_energy</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Receive the forces from the QM engine</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&lt;FORCES&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">forces</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Send the forces to the MM engine</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;&gt;FORCES&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">MDI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">forces</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">natoms</span><span class="p">,</span><span class="w"> </span><span class="n">MDI_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="c1">// Have the MM engine proceed to the @COORDS node, which completes the timestep</span>
<span class="w">    </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;@COORDS&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w"> </span>
<span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;timestep: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">iiteration</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mm_energy</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">qm_energy</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The above code does the following:</p>
<ul class="simple">
<li><p>Queries the number of atoms from the MM engine and allocates appropriately sized arrays for the coordinates and forces</p></li>
<li><p>Orders the MM engine to initialize a new MD simulation</p></li>
<li><p>Begins an iterative loop over MD iterations</p>
<ul>
<li><p>Receives the atomic coordinates from the MM engine and updates the QM engine with them</p></li>
<li><p>Receives the energy of the QM and MM systems</p></li>
<li><p>Receives the atomic forces from the QM engine and sends them to the MM engine</p></li>
<li><p>Orders the MM engine update the atomic coordinates</p></li>
</ul>
</li>
</ul>
<p>Finally, we should send an MDI command to cause the engines to exit.
Replace the comment that reads <code class="docutils literal notranslate"><span class="pre">//</span> <span class="pre">Send</span> <span class="pre">the</span> <span class="pre">&quot;EXIT&quot;</span> <span class="pre">command</span> <span class="pre">to</span> <span class="pre">each</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">engines</span></code> with the following:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-10" name="sd-tab-set-10" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-10">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Send the &quot;EXIT&quot; command to each of the engines</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;EXIT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mm_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">MDI_Send_command</span><span class="p">(</span><span class="s">&quot;EXIT&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qm_comm</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="driver-compilation">
<h2>Driver Compilation<a class="headerlink" href="#driver-compilation" title="Link to this heading">#</a></h2>
<p>The cookiecutter came with everything you need to build with CMake.
To compile, simply navigate to the directory where you want the driver to be built, then do the following, replacing <code class="docutils literal notranslate"><span class="pre">&lt;driver_top_directory&gt;</span></code> with the path to top directory of your driver repository.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-11" name="sd-tab-set-11" type="radio">
<label class="sd-tab-label" data-sync-group="code" data-sync-id="c++" for="sd-tab-item-11">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">cmake</span><span class="w"> </span><span class="o">&lt;</span><span class="n">driver_top_directory</span><span class="o">&gt;</span>
<span class="n">make</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-the-driver">
<h2>Using the Driver<a class="headerlink" href="#using-the-driver" title="Link to this heading">#</a></h2>
<p>To test the driver, you will need access to a QM engine and an MM engine.
The user tutorial describes how to compile QE and LAMMPS for this purpose.</p>
<p>You will also need appropriate input files for a test simulation.
The test files in the <code class="docutils literal notranslate"><span class="pre">MDI_AIMD_Driver</span></code> repository (see the user tutorial) will work fine, as will the scripts.
You can simply edit <code class="docutils literal notranslate"><span class="pre">MDI_AIMD_Driver/tests/locations/MDI_AIMD_Driver</span></code> to point to your new repository and run the scripts in the manner described in the user tutorial.</p>
</section>
<section id="final-notes">
<h2>Final Notes<a class="headerlink" href="#final-notes" title="Link to this heading">#</a></h2>
<p>Note that although we used QE as the QM code and LAMMPS as the MM code, we swap out QE for any QM engine with MDI support or LAMMPS for any MM engine with MDI support.
Furthermore, nothing about our AIMD driver strictly requires that the code named “QM” actually corresponds to a quantum mechanics code.
You could, for example, use LAMMPS as the QM code, while another instance of LAMMPS serves as the MM code.
Doing so would allow you to run  a calculation that will produce to same results as simply running an MD simulation entirely within a single instance of LAMMPS.
Although not generally useful for production runs, this can be a good way to benchmark the cost of the computational overhead introduced by using our driver as a middleman between two codes.</p>
<p>In other cases, it may be desirable to use two different MM codes as the engines if, for example, you wish to use a force field from one MM code and a thermostat from another MM code.
The only requirement on the engines is that the “QM” code supports all of the MDI commands sent by the AIMD driver to the “QM” engine, and that the “MM” code supports all of the MDI commands sent by the AIMD driver to the “MM” engine.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="running_driver.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Driver Use Tutorial: Running an AIMD Simulation</p>
      </div>
    </a>
    <a class="right-next"
       href="../user_guide/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">User Guide</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#starting-a-new-driver-project">Starting a New Driver Project</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-the-driver">Writing the Driver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#driver-compilation">Driver Compilation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-driver">Using the Driver</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#final-notes">Final Notes</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/getting_started/writing_driver.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  



  
  
  
  
  
  
  


<div class="row h-10">
    <div class="col-2">
        <a href="https://molssi.org/" target="_blank" title="Go to MolSSI in a new tab">
            <img src="../_static/molssi_main_logo.png" class="logo__image only-light footer_logo" alt="Logo image">
            <img src="../_static/molssi_main_logo_inverted_white.png" class="logo__image only-dark footer_logo" alt="Logo image">
        </a>
    </div>
    <div class="col-8">
        <p> &copy; Copyright 2019-2023 <a href="https://molssi.org/">The Molecular Sciences Software Institute</a></p>
        <p>Funded by the National Science Foundation 
          <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=1547580">OAC-1547580</a> and 
          <a href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=2136142">CHE-2136142.</a></p>
 
        
        <p class="sphinx-version">
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.2.3.<br>
        </p>
        

        <p class="theme-version">
        Built with a customized <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
        </p>

    </div>
    <div class="col-2">
        <a href="https://nsf.gov/" target="_blank" title="Go to the NSF in a new tab">
            <img src="../_static/nsf.png" class="footer_logo" alt="The NSF">
          </a>
    </div>
</div></div>
      
    </div>
  
  
  
</div>

  </footer>
  </body>
</html>