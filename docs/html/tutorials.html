<!-- HTML header for doxygen 1.8.16-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
 <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TFBQ45D');</script>
<!-- End Google Tag Manager -->
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Molssi Driver Interface Library: Tutorials</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
 <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TFBQ45D"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
  <td id="projectlogo"><img alt="Logo" src="mdi_main_logo_text_300x204.png"/></td>
  <td id="projectalign" style="padding-left: 6.0em;">
   <div id="projectname">Molssi Driver Interface Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Tutorials </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="user_tutorial"></a>
User Tutorial</h1>
<p>In this tutorial we will use an MDI driver to perform a simple <em> Ab Initio </em> Molecular Dynamics (AIMD) simulation, using Quantum ESPRESSO (QE) to calculate forces and LAMMPS to update the atomic coordinates each time step.</p>
<h2><a class="anchor" id="tutorial_engine_compile"></a>
Compiling the Engines</h2>
<p>We will need access to a QM code and an MM code, both of which must be capable of being run as an MDI engine. This tutorial will describe the use of Quantum ESPRESSO (QE) as the QM code and LAMMPS as the MM code; however, you can use any MDI-enabled QM and MM codes you prefer. A list of codes that support MDI can be found <a class="el" href="mdi_ecosystem.html">here</a>, along with instructions on how to compile them with MDI support.</p>
<p>Before moving to the next step, compile both <a class="el" href="mdi_ecosystem.html#ecosystem_qe">QE</a> and <a class="el" href="mdi_ecosystem.html#ecosystem_lammps">LAMMPS</a> (or your preferred QM and MM packages) with MDI support by following the <a class="el" href="mdi_ecosystem.html#ecosystem_overview">instructions provided</a>.</p>
<h2><a class="anchor" id="driver_compile"></a>
Compiling the AIMD Driver</h2>
<p>The MDI Standard supports the creation of many different types of drivers for a broad variety of applications. For this tutorial, we will download a simple AIMD driver:</p>
<div class="fragment"><div class="line">git clone git@github.com:MolSSI/MDI_AIMD_Driver.git</div></div><!-- fragment --><p>First, navigate to the directory where you want the driver to be compiled. For this tutorial, we will do:</p>
<div class="fragment"><div class="line">mkdir MDI_AIMD_Driver/build</div><div class="line">cd MDI_AIMD_Driver/build</div></div><!-- fragment --><p>Then compile using CMake:</p>
<div class="fragment"><div class="line">cmake ..</div><div class="line">make</div></div><!-- fragment --><h2><a class="anchor" id="user_run"></a>
Running the Simulation</h2>
<p>We will now run a simple AIMD simulation.</p>
<p>In <code>MDI_AIMD_Driver/tests/locations</code> there are three single-line text files, each of which is intended to indicate the location of one of the codes you installed above. Edit each of them so that they provide the absolute path to the corresponding code's executable.</p>
<p>There is a simple test calculation in <code>MDI_AIMD_Driver/tests/water</code>. Within this directory, the <code>data</code> subdirectory contains standard input files for LAMMPS and QE. The input files correspond to a small water box of 8 water molecule. They are exactly like any non-MDI input files for their respective codes, except for <code>data/lammps.in</code>. Near the end of <code>data/lammps.in</code> is an mdi fix, followed by an mdi command:</p>
<div class="fragment"><div class="line">fix             1 all mdi</div><div class="line">...</div><div class="line">mdi</div></div><!-- fragment --><p>These two lines are required in any LAMMPS input file that is intended to be used in conjuction with MDI. The mdi fix allows LAMMPS to communicate with the driver at the appropriate points throughout the simulation, while the mdi LAMMPS command indicates the point when LAMMPS begins listening for MDI commands from the driver.</p>
<p>There are two scripts associated with the water test: <code>tcp.sh</code> and <code>mpi.sh</code>. The <code>tcp.sh</code> script will run the simulation using the TCP/IP method for communicating between the driver and the engines. It consists of the following code:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#location of required codes</span></div><div class="line">DRIVER_LOC=$(cat ../locations/MDI_AIMD_Driver)</div><div class="line">LAMMPS_LOC=$(cat ../locations/LAMMPS)</div><div class="line">QE_LOC=$(cat ../locations/QE)</div><div class="line"> </div><div class="line">#remove old files</div><div class="line"><span class="keywordflow">if</span> [ -d work ]; then</div><div class="line">  rm -r work</div><div class="line">fi</div><div class="line"> </div><div class="line"><span class="preprocessor">#create work directory</span></div><div class="line">cp -r data work</div><div class="line">cd work</div><div class="line"> </div><div class="line">cd work</div><div class="line">${QE_LOC} -mdi <span class="stringliteral">&quot;-role ENGINE -name QM -method TCP -port 8021 -hostname localhost&quot;</span> -in qe.in &gt; qe.out &amp;</div><div class="line"> </div><div class="line"><span class="preprocessor">#launch LAMMPS</span></div><div class="line">${LAMMPS_LOC} -mdi <span class="stringliteral">&quot;-role ENGINE -name MM -method TCP -port 8021 -hostname localhost&quot;</span> -in lammps.in &gt; lammps.out &amp;</div><div class="line"> </div><div class="line"><span class="preprocessor">#launch driver</span></div><div class="line">${DRIVER_LOC} -mdi <span class="stringliteral">&quot;-role DRIVER -name driver -method TCP -port 8021&quot;</span> &amp;</div><div class="line"> </div><div class="line">wait</div></div><!-- fragment --><p>The first few lines simply read the location of the codes from the files in MDI_AIMD_Driver/tests/locations and copy the LAMMPS and QE input files into a subdirectory called <code>work</code>. Then the script launches QE. The QE launch command is exactly the same as a normal run of QE, except for the addition of a <code>-mdi</code> option. This option provides information to the MDI Library regarding how the codes will communicate with one another. Its argument is a string, which itself consists of a series of options that are read by the MDI Library. In this case, it provides the following options:</p>
<ul>
<li>role: Indicates whether this code will run as an <code>ENGINE</code> or a <code>DRIVER</code>.</li>
<li>name: Identifies the purpose of this engine. Each MDI driver will expect its engines to be named according to a particular standard. The MDI_AIMD_Driver engine expects one of the engines to be named "QM" and the other to be named "MM".</li>
<li>method: The communication method used to transfer information between the driver and the engines.</li>
<li>port: The port number that the driver will be listening over. Only used if the method is <code>TCP</code>.</li>
<li>hostname: The host name of the driver. Only used by engines and if the method is <code>TCP</code>.</li>
</ul>
<p>Note the presence of an ampersand ("&amp;") at the end of each run command, which causes the codes to run in the background. Without doing this, the script would launch QE and would wait until QE terminated before ever launching LAMMPS and the driver, leading to an indefinite hang. Finally, the wait command at the end ensures that the driver and the engines are permitted to terminate before the script terminates.</p>
<p>You can now execute the <code>tcp.sh</code> script, which should print out the energies of LAMMPS and QE for several timesteps of a short AIMD simulation.</p>
<p>If you compiled everything (QE, LAMMPS, MDI_AIMD_Driver, and the internal copies of the MDI Library) with MPI, you can also execute the <code>mpi.sh</code> script, which will run the same simulation using MPI for the inter-code communication. The output produced by QE and LAMMPS can be found in <code>work/qe.out</code> and <code>work/lammps.out</code>, respectively.</p>
<h1><a class="anchor" id="aimd_tutorial"></a>
Driver Development Tutorial</h1>
<p>Please complete the <a class="el" href="tutorials.html#user_tutorial">User Tutorial</a> before starting this tutorial.</p>
<p>In this tutorial we will set up a simple driver for running <em> Ab Initio </em> Molecular Dynamics (AIMD) simulations. We will use a quantum chemistry (QM) code to compute the forces, while using a molecular mechanics (MM) code to propagate the atomic coordinates each time step.</p>
<h2><a class="anchor" id="requirements_sec"></a>
Creating a New Project</h2>
<p>The easiest way to start work on a new driver is to use the MDI Driver Cookiecutter, which will automatically do most of the preparatory work for you. Using the cookiecutter will require that you have Python and Cookiecutter on your machine. If you do not already have Python installed, follow the directions on the <a href="https://www.python.org/">Python Website</a> and install both Python and the <code>pip</code> installer tool. To install Cookiecutter, type:</p>
<div class="fragment"><div class="line">pip install cookiecutter</div></div><!-- fragment --><p>If you are running on an external machine and do not have write permission to the system directories, you may need to add the <code>&ndash;user</code> option:</p>
<div class="fragment"><div class="line">pip install --user cookiecutter</div></div><!-- fragment --><p>Now use Cookiecutter to create a new driver project:</p>
<div class="fragment"><div class="line">cookiecutter git@github.com:MolSSI/MDI_Driver_Cookiecutter.git</div></div><!-- fragment --><p>When prompted for the <code>repo_name</code>, type <code>aimd</code>, and then when prompted to select a language, type <code>1</code> for C++. This will create a new directory called <code>aimd</code> and populate it with some of the things you will need for the driver, including a copy of the MDI Library. The overall directory structure is: </p><div class="fragment"><div class="line">.</div><div class="line">└── aimd</div><div class="line">    ├── CMakeLists.txt</div><div class="line">    ├── aimd</div><div class="line">        ├── CMakeLists.txt</div><div class="line">        ├── STUBS_MPI</div><div class="line">        │   └── mpi.h</div><div class="line">        └── aimd.cpp</div><div class="line">        └── mdi</div><div class="line">            ...</div></div><!-- fragment --><h2><a class="anchor" id="writing_sec"></a>
Writing the Driver</h2>
<p>Open the file called <code>aimd.cpp</code>. It contains the following code:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;mpi.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdexcept&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &quot;mdi.h&quot;</span></div><div class="line"> </div><div class="line"><span class="keyword">using namespace </span>std;</div><div class="line"> </div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div><div class="line"> </div><div class="line">  <span class="comment">// Initialize the MPI environment</span></div><div class="line">  MPI_Comm world_comm;</div><div class="line">  MPI_Init(&amp;argc, &amp;argv);</div><div class="line"> </div><div class="line">  <span class="comment">// Initialize MDI</span></div><div class="line">  <span class="keywordflow">if</span> ( <a class="code" href="mdi_8c.html#a9f26d9f67413c6c194a2f5e4bd69b911">MDI_Init</a>(&amp;argc, &amp;argv) ) {</div><div class="line">    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;The MDI library was not initialized correctly.&quot;</span>);</div><div class="line">  }</div><div class="line"> </div><div class="line">  <span class="comment">// Confirm that MDI was initialized successfully</span></div><div class="line">  <span class="keywordtype">int</span> initialized_mdi;</div><div class="line">  <span class="keywordflow">if</span> ( <a class="code" href="mdi_8c.html#a82aaa736f9d174c7663ad80a97089767">MDI_Initialized</a>(&amp;initialized_mdi) ) {</div><div class="line">    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;MDI_Initialized failed.&quot;</span>);</div><div class="line">  }</div><div class="line">  <span class="keywordflow">if</span> ( ! initialized_mdi ) {</div><div class="line">    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;MDI not initialized: did you provide the -mdi option?.&quot;</span>);</div><div class="line">  }</div><div class="line"> </div><div class="line">  <span class="comment">// Get the correct MPI intra-communicator for this code</span></div><div class="line">  <span class="keywordflow">if</span> ( <a class="code" href="mdi_8c.html#a1792db6705a7032640af46d5b05d23f4">MDI_MPI_get_world_comm</a>(&amp;world_comm) ) {</div><div class="line">    <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;MDI_MPI_get_world_comm failed.&quot;</span>);</div><div class="line">  }</div><div class="line"> </div><div class="line">  <span class="comment">// Connect to the engines</span></div><div class="line">  <span class="comment">// &lt;YOUR CODE GOES HERE&gt;</span></div><div class="line"> </div><div class="line">  <span class="comment">// Perform the simulation</span></div><div class="line">  <span class="comment">// &lt;YOUR CODE GOES HERE&gt;</span></div><div class="line"> </div><div class="line">  <span class="comment">// Send the &quot;EXIT&quot; command to each of the engines</span></div><div class="line">  <span class="comment">// &lt;YOUR CODE GOES HERE&gt;</span></div><div class="line"> </div><div class="line">  <span class="comment">// Synchronize all MPI ranks</span></div><div class="line">  MPI_Barrier(world_comm);</div><div class="line">  MPI_Finalize();</div><div class="line"> </div><div class="line">  <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>The first few lines of code simply initialize both MPI and and MDI. Don't worry if you don't have access to an MPI library - the code will just fall back to a set of dummy MPI functions provided in <code>STUBS_MPI</code>. The call to the <code><a class="el" href="mdi_8c.html#a1792db6705a7032640af46d5b05d23f4" title="Obtain the MPI communicator that spans the single code corresponding to the calling rank.">MDI_MPI_get_world_comm()</a></code> function obtains from MDI an MPI intra-communicator that spans all MPI ranks associated with the driver. This call is important when using the MPI protocol for MDI communication, because in that context, MPI_COMM_WORLD spans all ranks associated with both the driver and the engine(s). In general, an MDI-enabled code should call <code><a class="el" href="mdi_8c.html#a1792db6705a7032640af46d5b05d23f4" title="Obtain the MPI communicator that spans the single code corresponding to the calling rank.">MDI_MPI_get_world_comm()</a></code> immediately after calling <code><a class="el" href="mdi_8c.html#a9f26d9f67413c6c194a2f5e4bd69b911" title="Initialize communication through the MDI library.">MDI_Init()</a></code>, and the resulting MPI intra-communicator should be used instead of MPI_COMM_WORLD throughout the remainder of the code.</p>
<p>After initializing MDI, we need to connect the driver to its engines. For this particular tutorial, we will use a QM engine to calculate forces and an MM engine to update the atomic coordinates each timestep. In the MDI standard, engines request a connection to a driver. The driver will need to call the <code><a class="el" href="mdi_8c.html#a21a41738e9b43ab70c977f8ce63c0957" title="Accept a new MDI communicator.">MDI_Accept_communicator()</a></code> function to accept each connection. The general format of this functional call looks like this:</p>
<div class="fragment"><div class="line">MDI_Comm comm;</div><div class="line"><a class="code" href="mdi_8c.html#a21a41738e9b43ab70c977f8ce63c0957">MDI_Accept_communicator</a>(&amp;comm);</div></div><!-- fragment --><p>This will assign a new MDI communicator to <code>comm</code>, which functions very similarly to an MPI communicator and is used in certain MDI function calls to identify which engine is expected to send/receive data to/from the driver. Our AIMD driver will connect to two different engines, so we will be calling <code><a class="el" href="mdi_8c.html#a21a41738e9b43ab70c977f8ce63c0957" title="Accept a new MDI communicator.">MDI_Accept_communicator()</a></code> twice. We don't know the order in which the engines will request a connection to the driver, so we will need some way to determine which engine is the QM code and which engine is the MM code.</p>
<p>This can be accomplished through the use of the "<code>&lt;NAME"</code> command. The entire MDI standard is built around the idea that drivers can send "commands" to engines, each of which is defined by the MDI standard and has a specific outcome. The "<code>&lt;NAME"</code> command tells the engine to send the driver a string of length <code>MDI_NAME_LENGTH</code> that identifies the engine. The end-user is responsible for indicating the name of each engine at runtime, using the <code>-name</code> command line argument that was described in the <a class="el" href="tutorials.html#user_tutorial">User Tutorial</a>. As authors of a driver, we will need to decide what we expect each of the engines to be named and clearly document that decision for the benefit of the end-users. For the purpose of this tutorial, we will expect the quantum mechanics code to be called "QM" and the molecular mechanics code to be named "MM".</p>
<p>Sending the "<code>&lt;NAME"</code> command to an engine and then receiving the engine's name can be done as follows:</p>
<div class="fragment"><div class="line"><span class="keywordtype">char</span>* code_name = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="mdi_8c.html#a8ca47e903a62de4298767ef3d446901d">MDI_NAME_LENGTH</a>];</div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;NAME&quot;</span>, comm);</div><div class="line"><a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(code_name, <a class="code" href="mdi_8c.html#a8ca47e903a62de4298767ef3d446901d">MDI_NAME_LENGTH</a>, <a class="code" href="mdi_8c.html#a508f568d6a6cba24d6015347d6c1469e">MDI_CHAR</a>, comm);</div></div><!-- fragment --><p>The following code accepts connections from two engines and assigns the communicator from the engine named "MM" to <code>mm_comm</code> and assigns the communicator from the engine named "QM" to <code>qm_comm</code>. Replace the comment that reads "<code>// Connect to the engines</code>" with:</p>
<div class="fragment"><div class="line"><span class="comment">// Connect to the engines</span></div><div class="line">MDI_Comm mm_comm = <a class="code" href="mdi_8c.html#a01e277b0239a7304055c883adb759280">MDI_COMM_NULL</a>;</div><div class="line">MDI_Comm qm_comm = <a class="code" href="mdi_8c.html#a01e277b0239a7304055c883adb759280">MDI_COMM_NULL</a>;</div><div class="line"><span class="keywordtype">int</span> nengines = 2;</div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> iengine=0; iengine &lt; nengines; iengine++) {</div><div class="line">  MDI_Comm comm;</div><div class="line">  <a class="code" href="mdi_8c.html#a21a41738e9b43ab70c977f8ce63c0957">MDI_Accept_communicator</a>(&amp;comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Determine the name of this engine</span></div><div class="line">  <span class="keywordtype">char</span>* engine_name = <span class="keyword">new</span> <span class="keywordtype">char</span>[<a class="code" href="mdi_8c.html#a8ca47e903a62de4298767ef3d446901d">MDI_NAME_LENGTH</a>];</div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;NAME&quot;</span>, comm);</div><div class="line">  <a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(engine_name, <a class="code" href="mdi_8c.html#a8ca47e903a62de4298767ef3d446901d">MDI_NAME_LENGTH</a>, <a class="code" href="mdi_8c.html#a508f568d6a6cba24d6015347d6c1469e">MDI_CHAR</a>, comm);</div><div class="line"> </div><div class="line">  cout &lt;&lt; <span class="stringliteral">&quot;Engine name: &quot;</span> &lt;&lt; engine_name &lt;&lt; endl;</div><div class="line"> </div><div class="line">  <span class="keywordflow">if</span> ( strcmp(engine_name, <span class="stringliteral">&quot;MM&quot;</span>) == 0 ) {</div><div class="line">    <span class="keywordflow">if</span> ( mm_comm != <a class="code" href="mdi_8c.html#a01e277b0239a7304055c883adb759280">MDI_COMM_NULL</a> ) {</div><div class="line">  <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">&quot;Accepted a communicator from a second MM engine.&quot;</span>);</div><div class="line">    }</div><div class="line">    mm_comm = comm;</div><div class="line">  }</div><div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( strcmp(engine_name, <span class="stringliteral">&quot;QM&quot;</span>) == 0 ) {</div><div class="line">    <span class="keywordflow">if</span> ( qm_comm != <a class="code" href="mdi_8c.html#a01e277b0239a7304055c883adb759280">MDI_COMM_NULL</a> ) {</div><div class="line">  <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">&quot;Accepted a communicator from a second QM engine.&quot;</span>);</div><div class="line">    }</div><div class="line">    qm_comm = comm;</div><div class="line">  }</div><div class="line">  <span class="keywordflow">else</span> {</div><div class="line">    <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">&quot;Unrecognized engine name.&quot;</span>);</div><div class="line">  }</div><div class="line"> </div><div class="line">  <span class="keyword">delete</span>[] engine_name;</div><div class="line">}</div></div><!-- fragment --><p>We are now ready to use MDI to orchestrate an AIMD simulation. In broad terms, during each dynamics iteration we will send a set of atomic coordinates from the MM engine to the QM engine, order the QM engine to send the driver the corresponding atomic forces, send those forces to the MM engine, and order the MM engine to perform a time step.</p>
<p>Keep in mind that the driver doesn't know anything about the simulated system beyond what it can query by sending MDI commands. MDI engines initialize basic information about the system using whatever input file format the engine's developer chose. When the MM and QM engines are launched, they will each read their standard input files, perform basic initialization tasks, and then request a connection to the driver. The driver can request information about the engine's system by sending certain MDI commands. For example, to determine the number of atoms in the MM engine's system, you could do:</p>
<div class="fragment"><div class="line"><span class="comment">// Receive the number of atoms from the MM engine</span></div><div class="line"><span class="keywordtype">int</span> natoms;</div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;NATOMS&quot;</span>, mm_comm);</div><div class="line"><a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;natoms, 1, <a class="code" href="mdi_8c.html#ab88e0bb1563ba9fa73ffc49a704e43ad">MDI_INT</a>, mm_comm);</div></div><!-- fragment --><p>Similarly, to learn the coordinates of the atoms in the MM engine's system, you could do:</p>
<div class="fragment"><div class="line"><span class="comment">// Receive the coordinates from the MM engine</span></div><div class="line"><span class="keywordtype">double</span> coords[3*natoms];</div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;COORDS&quot;</span>, mm_comm);</div><div class="line"><a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;coords, 3*natoms, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, mm_comm);</div></div><!-- fragment --><p>You could then update the coordinates of the QM engine's system:</p>
<div class="fragment"><div class="line"><span class="comment">// Send the coordinates to the QM engine</span></div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&gt;COORDS&quot;</span>, qm_comm);</div><div class="line"><a class="code" href="mdi_8c.html#a7bebce6d5fa91ee99a34fdcc5dcaedea">MDI_Send</a>(&amp;coords, 3*natoms, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, qm_comm);</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>As we will discuss later in <a class="el" href="tutorials.html#tutorials_using_sec">Using the Driver</a>, this driver assumes that the engines have both been initialized with the same number of atoms, the same atom types and ordering of atom types, and the same cell dimensions.</dd></dl>
<p>The following code will handle all of the work associated with driving an AIMD simulation Replace the comment that reads "<code>// Perform the simulation</code>" with:</p>
<div class="fragment"><div class="line"><span class="comment">// Perform the simulation</span></div><div class="line"><span class="keywordtype">int</span> niterations = 10;  <span class="comment">// Number of MD iterations</span></div><div class="line"><span class="keywordtype">int</span> natoms;</div><div class="line"><span class="keywordtype">double</span> qm_energy;</div><div class="line"><span class="keywordtype">double</span> mm_energy;</div><div class="line"> </div><div class="line"><span class="comment">// Receive the number of atoms from the MM engine</span></div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;NATOMS&quot;</span>, mm_comm);</div><div class="line"><a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;natoms, 1, <a class="code" href="mdi_8c.html#ab88e0bb1563ba9fa73ffc49a704e43ad">MDI_INT</a>, mm_comm);</div><div class="line"> </div><div class="line"><span class="comment">// Allocate the arrays for the coordinates and forces</span></div><div class="line"><span class="keywordtype">double</span> coords[3*natoms];</div><div class="line"><span class="keywordtype">double</span> forces[3*natoms];</div><div class="line"> </div><div class="line"><span class="comment">// Have the MM engine initialize a new MD simulation</span></div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;@INIT_MD&quot;</span>, mm_comm);</div><div class="line"> </div><div class="line"><span class="comment">// Perform each iteration of the simulation</span></div><div class="line"><span class="keywordflow">for</span> (<span class="keywordtype">int</span> iiteration = 0; iiteration &lt; niterations; iiteration++) {</div><div class="line"> </div><div class="line">  <span class="comment">// Receive the coordinates from the MM engine</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;COORDS&quot;</span>, mm_comm);</div><div class="line">  <a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;coords, 3*natoms, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, mm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Send the coordinates to the QM engine</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&gt;COORDS&quot;</span>, qm_comm);</div><div class="line">  <a class="code" href="mdi_8c.html#a7bebce6d5fa91ee99a34fdcc5dcaedea">MDI_Send</a>(&amp;coords, 3*natoms, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, qm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Have the MM engine proceed to the @FORCES node</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;@FORCES&quot;</span>, mm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Get the QM energy</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;ENERGY&quot;</span>, qm_comm);</div><div class="line">  <a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;qm_energy, 1, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, qm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Get the MM energy</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;ENERGY&quot;</span>, mm_comm);</div><div class="line">  <a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;mm_energy, 1, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, mm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Receive the forces from the QM engine</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&lt;FORCES&quot;</span>, qm_comm);</div><div class="line">  <a class="code" href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a>(&amp;forces, 3*natoms, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, qm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Send the forces to the MM engine</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;&gt;FORCES&quot;</span>, mm_comm);</div><div class="line">  <a class="code" href="mdi_8c.html#a7bebce6d5fa91ee99a34fdcc5dcaedea">MDI_Send</a>(&amp;forces, 3*natoms, <a class="code" href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a>, mm_comm);</div><div class="line"> </div><div class="line">  <span class="comment">// Have the MM engine proceed to the @COORDS node, which completes the timestep</span></div><div class="line">  <a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;@COORDS&quot;</span>, mm_comm);</div><div class="line"> </div><div class="line">  cout &lt;&lt; <span class="stringliteral">&quot;timestep: &quot;</span> &lt;&lt; iiteration &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; mm_energy &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; qm_energy &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><p>The above code does the following:</p><ol type="1">
<li>Queries the number of atoms from the MM engine and allocates appropriately sized arrays for the coordinates and forces</li>
<li>Orders the MM engine to initialize a new MD simulation</li>
<li>Begins an iterative loop over MD iterations<ol type="a">
<li>Receives the atomic coordinates from the MM engine and updates the QM engine with them</li>
<li>Receives the energy of the QM and MM systems</li>
<li>Receives the atomic forces from the QM engine and sends them to the MM engine</li>
<li>Orders the MM engine update the atomic coordinates</li>
</ol>
</li>
</ol>
<p>Finally, we should send an MDI command to cause the engines to exit. Replace the comment that reads "<code>// Send the "EXIT" command to each of the engines</code>" with the following:</p>
<div class="fragment"><div class="line"><span class="comment">// Send the &quot;EXIT&quot; command to each of the engines</span></div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;EXIT&quot;</span>, mm_comm);</div><div class="line"><a class="code" href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a>(<span class="stringliteral">&quot;EXIT&quot;</span>, qm_comm);</div></div><!-- fragment --><h2><a class="anchor" id="compile_sec"></a>
Driver Compilation</h2>
<p>The cookiecutter came with everything you need to build with CMake. To compile, simply navigate to the directory where you want the driver to be built, then do the following, replacing "&lt;<code>driver_top_directory&gt;"</code> with the path to top directory of your driver repository.</p>
<div class="fragment"><div class="line">cmake &lt;driver_top_directory&gt;</div><div class="line">make</div></div><!-- fragment --><h2><a class="anchor" id="tutorials_using_sec"></a>
Using the Driver</h2>
<p>To test the driver, you will need access to a QM engine and an MM engine. The <a class="el" href="tutorials.html#user_tutorial">User Tutorial</a> describes how to compile QE and LAMMPS for this purpose.</p>
<p>You will also need appropriate input files for a test simulation. The test files in the MDI_AIMD_Driver repository (see the <a class="el" href="tutorials.html#user_tutorial">User Tutorial</a>) will work fine, as will the scripts. You can simply edit MDI_AIMD_Driver/tests/locations/MDI_AIMD_Driver to point to your new repository and run the scripts in the manner described in the <a class="el" href="tutorials.html#user_tutorial">User Tutorial</a>.</p>
<h2><a class="anchor" id="final_notes"></a>
Final Notes</h2>
<p>Note that although we used QE as the QM code and LAMMPS as the MM code, we swap out QE for any QM engine with MDI support or LAMMPS for any MM engine with MDI support. Furthermore, nothing about our AIMD driver strictly requires that the code named "QM" actually corresponds to a quantum mechanics code. You could, for example, use LAMMPS as the QM code, while another instance of LAMMPS serves as the MM code. Doing so would allow you to run a calculation that will produce to same results as simply running an MD simulation entirely within a single instance of LAMMPS. Although not generally useful for production runs, this can be a good way to benchmark the cost of the computational overhead introduced by using our driver as a middleman between two codes.</p>
<p>In other cases, it may be desirable to use two different MM codes as the engines if, for example, you wish to use a force field from one MM code and a thermostat from another MM code. The only requirement on the engines is that the "QM" code supports all of the MDI commands sent by the AIMD driver to the "QM" engine, and that the "MM" code supports all of the MDI commands sent by the AIMD driver to the "MM" engine. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<div class="ttc" id="amdi_8c_html_a1792db6705a7032640af46d5b05d23f4"><div class="ttname"><a href="mdi_8c.html#a1792db6705a7032640af46d5b05d23f4">MDI_MPI_get_world_comm</a></div><div class="ttdeci">int MDI_MPI_get_world_comm(void *world_comm)</div><div class="ttdoc">Obtain the MPI communicator that spans the single code corresponding to the calling rank.</div><div class="ttdef"><b>Definition:</b> mdi.c:1565</div></div>
<div class="ttc" id="amdi_8c_html_a82aaa736f9d174c7663ad80a97089767"><div class="ttname"><a href="mdi_8c.html#a82aaa736f9d174c7663ad80a97089767">MDI_Initialized</a></div><div class="ttdeci">int MDI_Initialized(int *flag)</div><div class="ttdoc">Indicates whether MDI_Init has been called.</div><div class="ttdef"><b>Definition:</b> mdi.c:184</div></div>
<div class="ttc" id="amdi_8c_html_a01e277b0239a7304055c883adb759280"><div class="ttname"><a href="mdi_8c.html#a01e277b0239a7304055c883adb759280">MDI_COMM_NULL</a></div><div class="ttdeci">const MDI_Comm MDI_COMM_NULL</div><div class="ttdoc">value of a null communicator</div><div class="ttdef"><b>Definition:</b> mdi.c:55</div></div>
<div class="ttc" id="amdi_8c_html_a7bebce6d5fa91ee99a34fdcc5dcaedea"><div class="ttname"><a href="mdi_8c.html#a7bebce6d5fa91ee99a34fdcc5dcaedea">MDI_Send</a></div><div class="ttdeci">int MDI_Send(const void *buf, int count, MDI_Datatype datatype, MDI_Comm comm)</div><div class="ttdoc">Send data through the MDI connection.</div><div class="ttdef"><b>Definition:</b> mdi.c:233</div></div>
<div class="ttc" id="amdi_8c_html_a3d0c16831c941e5b870461394bfe5c82"><div class="ttname"><a href="mdi_8c.html#a3d0c16831c941e5b870461394bfe5c82">MDI_DOUBLE</a></div><div class="ttdeci">const int MDI_DOUBLE</div><div class="ttdoc">double precision float data type</div><div class="ttdef"><b>Definition:</b> mdi.c:77</div></div>
<div class="ttc" id="amdi_8c_html_a8ca47e903a62de4298767ef3d446901d"><div class="ttname"><a href="mdi_8c.html#a8ca47e903a62de4298767ef3d446901d">MDI_NAME_LENGTH</a></div><div class="ttdeci">const int MDI_NAME_LENGTH</div><div class="ttdoc">length of an MDI name in characters</div><div class="ttdef"><b>Definition:</b> mdi.c:49</div></div>
<div class="ttc" id="amdi_8c_html_ab73f32323a155011fcc184866215ba03"><div class="ttname"><a href="mdi_8c.html#ab73f32323a155011fcc184866215ba03">MDI_Recv</a></div><div class="ttdeci">int MDI_Recv(void *buf, int count, MDI_Datatype datatype, MDI_Comm comm)</div><div class="ttdoc">Receive data through the MDI connection.</div><div class="ttdef"><b>Definition:</b> mdi.c:257</div></div>
<div class="ttc" id="amdi_8c_html_a3fa5769d2a6d0ad305fdaa12b048056e"><div class="ttname"><a href="mdi_8c.html#a3fa5769d2a6d0ad305fdaa12b048056e">MDI_Send_command</a></div><div class="ttdeci">int MDI_Send_command(const char *buf, MDI_Comm comm)</div><div class="ttdoc">Send a command of length MDI_COMMAND_LENGTH through the MDI connection.</div><div class="ttdef"><b>Definition:</b> mdi.c:293</div></div>
<div class="ttc" id="amdi_8c_html_a9f26d9f67413c6c194a2f5e4bd69b911"><div class="ttname"><a href="mdi_8c.html#a9f26d9f67413c6c194a2f5e4bd69b911">MDI_Init</a></div><div class="ttdeci">int MDI_Init(int *argc, char ***argv)</div><div class="ttdoc">Initialize communication through the MDI library.</div><div class="ttdef"><b>Definition:</b> mdi.c:112</div></div>
<div class="ttc" id="amdi_8c_html_a21a41738e9b43ab70c977f8ce63c0957"><div class="ttname"><a href="mdi_8c.html#a21a41738e9b43ab70c977f8ce63c0957">MDI_Accept_communicator</a></div><div class="ttdeci">MDI_Comm MDI_Accept_communicator(MDI_Comm *comm)</div><div class="ttdoc">Accept a new MDI communicator.</div><div class="ttdef"><b>Definition:</b> mdi.c:208</div></div>
<div class="ttc" id="amdi_8c_html_a508f568d6a6cba24d6015347d6c1469e"><div class="ttname"><a href="mdi_8c.html#a508f568d6a6cba24d6015347d6c1469e">MDI_CHAR</a></div><div class="ttdeci">const int MDI_CHAR</div><div class="ttdoc">character data type</div><div class="ttdef"><b>Definition:</b> mdi.c:79</div></div>
<div class="ttc" id="amdi_8c_html_ab88e0bb1563ba9fa73ffc49a704e43ad"><div class="ttname"><a href="mdi_8c.html#ab88e0bb1563ba9fa73ffc49a704e43ad">MDI_INT</a></div><div class="ttdeci">const int MDI_INT</div><div class="ttdoc">integer data type</div><div class="ttdef"><b>Definition:</b> mdi.c:59</div></div>
<!-- HTML footer for doxygen 1.8.16-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
